---
// No props needed for smart popup
---

<!-- Pop-up inteligente -->
<div
  id="smartPopup"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
>
  <div
    class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95"
    id="popupContent"
  >
    <div class="p-6 text-center">
      <!-- Header del popup -->
      <div class="mb-4">
        <div class="text-4xl mb-2">‚è∞</div>
        <h3 class="text-2xl font-bold text-brand mb-2">¬øTienes prisa?</h3>
        <p class="text-secondary">¬°Te llamamos GRATIS en 2 minutos!</p>
      </div>

      <!-- Formulario del popup -->
      <form id="callbackForm" class="space-y-4" novalidate>
        <div class="space-y-3">
          <input
            type="text"
            id="popupName"
            name="name"
            placeholder="Tu nombre"
            required
            class="w-full px-4 py-3 rounded-lg border-2 border-[#bbd4ce] focus:border-[#FAE360] focus:outline-none text-gray-800 placeholder-gray-500"
          />
          <input
            type="tel"
            id="popupPhone"
            name="phone"
            placeholder="Tu tel√©fono (ej: 640 50 60 84)"
            required
            pattern="^(?=(?:.*\\d){9,})(?:\\+|\\d)[\\d\\s\-()\\+]*$"
            class="w-full px-4 py-3 rounded-lg border-2 border-[#bbd4ce] focus:border-[#FAE360] focus:outline-none text-gray-800 placeholder-gray-500"
          />
        </div>

        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <button
            type="submit"
            class="btn-primary rounded-lg flex-1 flex items-center justify-center space-x-2"
          >
            <span>üìû</span>
            <span>¬°Llamar ahora!</span>
          </button>

          <button
            type="button"
            id="closePopup"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors duration-300 flex-1"
          >
            Quiz√°s luego
          </button>
        </div>
      </form>

      <!-- Mensaje de confianza -->
      <div class="mt-4 pt-4 border-t border-gray-200">
        <p class="text-xs text-secondary">
          ‚úì Llamada gratuita ‚úì Sin compromiso ‚úì Atenci√≥n profesional 24/7
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  import { EmailService } from "@/lib/utils/emailService.js";

  // Variables globales del popup
  let popupTimer: NodeJS.Timeout;
  let popupShown = false;

  // Funci√≥n para mostrar el popup
  function showPopup(): void {
    if (popupShown) return;

    const popup = document.getElementById("smartPopup");
    const content = document.getElementById("popupContent");

    if (popup && content) {
      popupShown = true;
      popup.classList.remove("hidden");
      popup.classList.add("flex");

      // Animaci√≥n de entrada
      setTimeout(() => {
        content.classList.remove("scale-95");
        content.classList.add("scale-100");
      }, 100);
    }
  }

  // Funci√≥n para ocultar el popup
  function hidePopup(): void {
    const popup = document.getElementById("smartPopup");
    const content = document.getElementById("popupContent");

    if (popup && content) {
      content.classList.remove("scale-100");
      content.classList.add("scale-95");

      setTimeout(() => {
        popup.classList.add("hidden");
        popup.classList.remove("flex");
      }, 300);
    }
  }

  // Funci√≥n para inicializar el timer del popup
  function initPopupTimer(): void {
    // Limpiar timer existente si ya hay uno
    if (popupTimer) {
      clearTimeout(popupTimer);
    }

    // Solo mostrar popup si no es mobile (pantallas > 768px)
    if (window.innerWidth > 768) {
      popupTimer = setTimeout(showPopup, 45000); // 45 segundos
    }
  }

  // Funci√≥n para manejar los eventos de cierre del popup
  function initPopupCloseEvents(): void {
    // Cerrar popup con el bot√≥n "Quiz√°s luego"
    const closeButton = document.getElementById("closePopup");
    if (closeButton) {
      closeButton.addEventListener("click", hidePopup);
    }

    // Cerrar popup al hacer clic fuera del contenido
    const popup = document.getElementById("smartPopup");
    if (popup) {
      popup.addEventListener("click", function (e) {
        if (e.target === this) {
          // Si el usuario est√° escribiendo en un input, ignorar clicks fuera
          const active = document.activeElement;
          if (active && this.contains(active)) return;
          hidePopup();
        }
      });
    }
  }

  // Funci√≥n para manejar el formulario del popup
  function initPopupForm(): void {
    const form = document.getElementById("callbackForm");
    if (!form) return;

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const name = (document.getElementById("popupName") as HTMLInputElement)
        ?.value;
      const phone = (document.getElementById("popupPhone") as HTMLInputElement)
        ?.value;

      if (!name || !phone) {
        alert(
          "Por favor, completa todos los campos para que podamos contactarte."
        );
        return;
      }

      // Normalizar tel√©fono y validar: al menos 9 d√≠gitos
      const phoneDigits = phone.replace(/\D/g, "");
      if (phoneDigits.length < 9) {
        alert("Por favor, introduce un tel√©fono v√°lido (m√≠n. 9 d√≠gitos).");
        return;
      }

      // Mostrar estado de carga
      const submitButton = document.querySelector(
        '#callbackForm button[type="submit"]'
      );
      if (submitButton) {
        submitButton.innerHTML = "<span>‚è≥</span><span>Enviando...</span>";
        submitButton.setAttribute("disabled", "true");
      }

      // Intentar env√≠o por EmailJS primero
      const emailResult = await EmailService.sendPopupEmail({
        from_name: name,
        from_phone: phoneDigits || phone,
        message: `¬°SOLICITUD URGENTE! Soy ${name}. Por favor ll√°menme URGENTE al ${phoneDigits || phone} para presupuesto de mudanza.`,
      });

      // Configuraci√≥n de WhatsApp
      const customerPhone = (phoneDigits || phone).replace(/^0+/, "");
      const businessNumber = "640506084";
      const message = `¬°Hola! Soy ${name}. Mi tel√©fono es ${customerPhone}. Por favor ll√°menme URGENTE para presupuesto de mudanza. ¬°Tengo prisa!`;
      const whatsappUrl = `https://wa.me/34${businessNumber}?text=${encodeURIComponent(message)}`;
      const whatsappAppUrl = `whatsapp://send?phone=34${businessNumber}&text=${encodeURIComponent(message)}`;

      // Mostrar mensaje de √©xito
      const popupContent = document.getElementById("popupContent");
      if (popupContent) {
        if (emailResult.success) {
          // √âxito con EmailJS
          popupContent.innerHTML = `
          <div class="p-6 text-center">
            <div class="text-4xl mb-4">‚úÖ</div>
            <h3 class="text-2xl font-bold text-[#264e70] mb-4">¬°Perfecto!</h3>
            <p class="text-[#679186] mb-4">${emailResult.message}</p>
            <p class="text-[#679186] mb-4">Te llamaremos al <strong>${phone}</strong> en menos de 2 minutos.</p>
            <p class="text-sm text-[#679186] mb-6">Si necesitas contacto inmediato, tambi√©n puedes llamarnos directamente:</p>
            
            <div class="space-y-3">
              <a href="tel:+34933539792" class="block bg-[#679186] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#5a7a6f] transition-colors duration-300">
                üìû Llamar: 933 53 97 92
              </a>
              <a href="${whatsappUrl}" target="_blank" rel="noopener noreferrer" class="block bg-[#FAE360] text-[#264e70] font-bold py-3 px-6 rounded-lg hover:bg-[#f0d84a] transition-colors duration-300">
                üí¨ WhatsApp: 640 50 60 84
              </a>
              <button id="copyAndOpenWhatsApp" class="w-full mt-2 bg-[#f7c9a8] text-[#264e70] font-bold py-3 px-6 rounded-lg hover:bg-[#f5bf95] transition-colors duration-300">Copiar mensaje y abrir WhatsApp</button>
            </div>
            
            <button id="closeSuccessPopup" class="mt-4 text-gray-500 hover:text-gray-700 text-sm underline">
              Cerrar
            </button>
          </div>
        `;
        } else {
          // Error EmailJS - usar WhatsApp como backup
          popupContent.innerHTML = `
          <div class="p-6 text-center">
            <div class="text-4xl mb-4">üì±</div>
            <h3 class="text-2xl font-bold text-[#264e70] mb-4">¬°Te contactamos por WhatsApp!</h3>
            <p class="text-[#679186] mb-4">Te llamaremos al <strong>${phone}</strong> en menos de 2 minutos.</p>
            <p class="text-sm text-[#679186] mb-6">Si necesitas contacto inmediato, tambi√©n puedes llamarnos directamente:</p>
            
            <div class="space-y-3">
              <a href="tel:+34933539792" class="block bg-[#679186] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#5a7a6f] transition-colors duration-300">
                üìû Llamar: 933 53 97 92
              </a>
              <a href="${whatsappUrl}" target="_blank" rel="noopener noreferrer" class="block bg-[#FAE360] text-[#264e70] font-bold py-3 px-6 rounded-lg hover:bg-[#f0d84a] transition-colors duration-300">
                üí¨ WhatsApp: 640 50 60 84
              </a>
              <button id="copyAndOpenWhatsApp" class="w-full mt-2 bg-[#f7c9a8] text-[#264e70] font-bold py-3 px-6 rounded-lg hover:bg-[#f5bf95] transition-colors duration-300">Copiar mensaje y abrir WhatsApp</button>
            </div>
            
            <button id="closeSuccessPopup" class="mt-4 text-gray-500 hover:text-gray-700 text-sm underline">
              Cerrar
            </button>
          </div>
        `;
          // Intentar abrir la app nativa de WhatsApp primero
          try {
            window.location.href = whatsappAppUrl;
            setTimeout(() => window.open(whatsappUrl, "_blank"), 800);
          } catch (err) {
            window.open(whatsappUrl, "_blank");
          }
        }

        // Event listeners para el contenido de √©xito
        initSuccessPopupEvents(whatsappUrl, whatsappAppUrl, message);
      }
    });
  }

  // Funci√≥n para manejar eventos del popup de √©xito
  function initSuccessPopupEvents(
    whatsappUrl: string,
    whatsappAppUrl: string,
    message: string
  ): void {
    // Cerrar popup de √©xito
    const closeSuccessButton = document.getElementById("closeSuccessPopup");
    if (closeSuccessButton) {
      closeSuccessButton.addEventListener("click", hidePopup);
    }

    // WhatsApp links dentro del popup
    const popupContent = document.getElementById("popupContent");
    if (popupContent) {
      const waAnchor = popupContent.querySelector(
        'a[href^="https://wa.me"], a[href^="https://api.whatsapp.com"]'
      );
      if (waAnchor) {
        waAnchor.addEventListener("click", (ev) => {
          ev.preventDefault();
          try {
            window.location.href = whatsappAppUrl;
            setTimeout(() => window.open(whatsappUrl, "_blank"), 800);
          } catch (e) {
            window.open(whatsappUrl, "_blank");
          }
        });
      }

      // Bot√≥n copiar y abrir WhatsApp
      const copyBtn = popupContent.querySelector("#copyAndOpenWhatsApp");
      if (copyBtn) {
        copyBtn.addEventListener("click", async (ev) => {
          ev.preventDefault();
          try {
            await navigator.clipboard.writeText(message);
            (copyBtn as HTMLElement).innerText = "Copiado ‚Äî Abriendo...";
          } catch (e) {
            // ignore clipboard errors
          }
          try {
            window.location.href = whatsappAppUrl;
            setTimeout(() => window.open(whatsappUrl, "_blank"), 800);
          } catch (e) {
            window.open(whatsappUrl, "_blank");
          }
        });
      }
    }
  }

  // Funci√≥n principal para inicializar el popup
  function initSmartPopup(): void {
    // Reset del estado del popup
    popupShown = false;

    // Inicializar eventos de cierre
    initPopupCloseEvents();

    // Inicializar formulario
    initPopupForm();

    // Inicializar timer
    initPopupTimer();

    console.log("SmartPopup inicializado correctamente");
  }

  // Limpiar timer al salir de la p√°gina
  function cleanupPopup(): void {
    if (popupTimer) {
      clearTimeout(popupTimer);
    }
  }

  // Inicializaci√≥n y eventos
  document.addEventListener("DOMContentLoaded", initSmartPopup);

  // Soporte para View Transitions
  document.addEventListener("astro:after-swap", initSmartPopup);

  // Limpiar al salir
  window.addEventListener("beforeunload", cleanupPopup);
</script>
