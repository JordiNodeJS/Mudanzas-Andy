---
// No props needed for contact form
---

<!-- Formulario sticky en footer -->
<div
  class="fixed bottom-0 left-0 right-0 bg-secondary text-white z-10 transform transition-all duration-500 ease-in-out"
  id="contactForm"
  style="box-shadow: 0 0 15px -3px rgba(0, 0, 0, 0.1), 4px 0 6px -4px rgba(0, 0, 0, 0.1), -4px 0 6px -4px rgba(0, 0, 0, 0.1);"
>
  <div class="container mx-auto px-4 py-3 lg:py-4">
    <div
      class="flex flex-col lg:flex-row items-center justify-between space-y-3 lg:space-y-0 lg:space-x-6"
    >
      <!-- Texto del formulario -->
      <div class="text-center lg:text-left flex-shrink-0">
        <p class="font-bold text-highlight text-sm lg:text-base">
          ¬°Presupuesto GRATIS en 10 minutos!
        </p>
        <p class="text-xs text-neutral">
          Te contactaremos por WhatsApp inmediatamente
        </p>
      </div>

      <!-- Formulario -->
      <form
        class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full lg:w-auto max-w-2xl"
        id="budgetForm"
        novalidate
      >
        <div
          class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 flex-1 min-w-0"
        >
          <input
            type="text"
            id="name"
            name="name"
            placeholder="Tu nombre"
            required
            class="px-4 py-2 rounded-lg border-2 border-[#bbd4ce] focus:border-[#FAE360] focus:outline-none bg-white text-gray-800 placeholder-gray-500 min-w-0 flex-1"
          />
          <input
            type="email"
            id="email"
            name="email"
            placeholder="tu@email.com"
            required
            class="px-4 py-2 rounded-lg border-2 border-[#bbd4ce] focus:border-[#FAE360] focus:outline-none bg-white text-gray-800 placeholder-gray-500 min-w-0 flex-1"
          />
          <input
            type="tel"
            id="phone"
            name="phone"
            placeholder="640 50 60 84"
            pattern="^(?=(?:.*\\d){9,})(?:\\+|\\d)[\\d\\s\-()\\+]*$"
            class="px-4 py-2 rounded-lg border-2 border-[#bbd4ce] focus:border-[#FAE360] focus:outline-none bg-white text-gray-800 placeholder-gray-500 min-w-0 flex-1"
          />
        </div>

        <button
          type="submit"
          class="btn-primary rounded-lg flex items-center justify-center space-x-2 text-sm lg:text-base min-w-0"
        >
          <span>‚úÖ</span>
          <span class="hidden sm:inline">¬°Recibe presupuesto en 10 min!</span>
          <span class="sm:hidden">¬°Presupuesto!</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Bot√≥n para minimizar/maximizar -->
  <button
    class="absolute top-0 left-4 transform -translate-y-full bg-secondary text-white px-3 py-1 rounded-t-lg text-sm hover:bg-[#5a7a6f] transition-colors duration-300 border-0"
    id="toggleForm"
    style="border: none; box-shadow: none; margin-bottom: -1px;"
  >
    ‚Üì
  </button>
</div>

<script>
  import { EmailService } from "@/lib/utils/emailService.js";

  // Validaci√≥n y env√≠o del formulario
  document
    .getElementById("budgetForm")
    ?.addEventListener("submit", async function (e) {
      e.preventDefault();

      const name = (document.getElementById("name") as HTMLInputElement)?.value;
      const email = (document.getElementById("email") as HTMLInputElement)
        ?.value;
      const phone = (document.getElementById("phone") as HTMLInputElement)
        ?.value;

      // Custom validation to avoid native browser tooltips which can be clipped
      // or positioned off-screen when the form is fixed at the bottom.
      /**
       * Show a short-lived validation tooltip above the sticky contact form.
       */
      function showValidationTooltip(msg: string) {
        const container = document.getElementById("contactForm");
        if (!container) return;

        let tip = document.getElementById("contactFormTooltip");
        if (!tip) {
          tip = document.createElement("div");
          tip.id = "contactFormTooltip";
          tip.className = "contact-tooltip show";
          container.appendChild(tip);
        }

        tip.textContent = msg;
        tip.classList.remove("hidden");
        tip.classList.add("show");

        // Define el tipo extendido para el elemento con la propiedad custom
        type TipElementWithTimeout = HTMLElement & { _removeTimeout?: number };
        const tipWithTimeout = tip as TipElementWithTimeout;

        if (tipWithTimeout._removeTimeout) {
          clearTimeout(tipWithTimeout._removeTimeout);
        }

        tipWithTimeout._removeTimeout = setTimeout(() => {
          tip.classList.remove("show");
          tip.classList.add("hidden");
        }, 4000) as unknown as number;
      }

      if (!name || !email) {
        showValidationTooltip(
          "Por favor, completa tu nombre y email para que podamos enviarte el presupuesto."
        );
        return;
      }

      // Validar tel√©fono: al menos 9 d√≠gitos num√©ricos (se aceptan espacios, par√©ntesis, +34, guiones)
      const phoneDigits = phone ? phone.replace(/\D/g, "") : "";
      if (phone && phoneDigits.length < 9) {
        showValidationTooltip(
          "Por favor, introduce un tel√©fono v√°lido (m√≠n. 9 d√≠gitos)."
        );
        return;
      }

      // Mostrar estado de carga
      const submitButton = document.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.innerHTML = "<span>‚è≥</span><span>Enviando...</span>";
        submitButton.setAttribute("disabled", "true");
      }

      // Intentar env√≠o por EmailJS primero
      const emailResult = await EmailService.sendContactEmail({
        from_name: name,
        from_email: email,
        // Enviar el tel√©fono normalizado (solo d√≠gitos) si existe, para evitar formatos no deseados
        from_phone: phoneDigits || phone,
        message: `Solicitud de presupuesto de mudanza desde la web mudanzasandy.com 
        Nombre: ${name}
        Email: ${email}
        ${phone ? `Tel√©fono: ${phoneDigits || phone}` : ""}
        
        Por favor contactar cuanto antes para presupuesto de mudanza.`,
      });

      // Mensaje personalizado para WhatsApp (backup)
      const message = `¬°Hola! Soy ${name}. Solicito presupuesto de mudanza. Email: ${email}${phone ? ` | Tel√©fono: ${phone}` : ""}. ¬°Por favor contactenme cuanto antes!`;
      const whatsappUrl = `https://wa.me/34640506084?text=${encodeURIComponent(message)}`;

      // Mostrar resultado
      const formContainer = document.getElementById("contactForm");
      if (formContainer) {
        if (emailResult.success) {
          // √âxito con EmailJS
          formContainer.innerHTML = `
            <div class="container mx-auto px-4 py-4 text-center">
              <div class="bg-green-500 text-white p-4 rounded-lg">
                <p class="font-bold">‚úÖ ${emailResult.message}</p>
                <p class="text-sm mt-2">¬øNecesitas ayuda URGENTE? <a href="tel:+34933539792" class="underline font-bold">Llama ahora al 933 53 97 92</a></p>
                <a href="${whatsappUrl}" target="_blank" rel="noopener noreferrer" class="inline-block mt-3 bg-[#FAE360] text-[#264e70] px-4 py-2 rounded-lg font-bold hover:bg-[#f0d84a] transition-colors duration-300">
                  Tambi√©n v√≠a WhatsApp üí¨
                </a>
              </div>
            </div>
          `;
        } else {
          // Error EmailJS - usar WhatsApp como backup
          formContainer.innerHTML = `
            <div class="container mx-auto px-4 py-4 text-center">
              <div class="bg-yellow-500 text-white p-4 rounded-lg">
                <p class="font-bold">Te contactaremos por WhatsApp inmediatamente</p>
                <p class="text-sm mt-2">¬øNecesitas ayuda URGENTE? <a href="tel:+34933539792" class="underline font-bold">Llama ahora al 933 53 97 92</a></p>
                <a href="${whatsappUrl}" target="_blank" rel="noopener noreferrer" class="inline-block mt-3 bg-[#FAE360] text-[#264e70] px-4 py-2 rounded-lg font-bold hover:bg-[#f0d84a] transition-colors duration-300">
                  Abrir WhatsApp üí¨
                </a>
              </div>
            </div>
          `;
          // Abrir WhatsApp autom√°ticamente en caso de error
          window.open(whatsappUrl, "_blank");
        }
      }
    });

  // Funcionalidad para minimizar/maximizar formulario
  document.getElementById("toggleForm")?.addEventListener("click", function () {
    const form = document.getElementById("contactForm");
    const button = this;

    if (form?.classList.contains("translate-y-full")) {
      form.classList.remove("translate-y-full");
      button.textContent = "‚Üì";
    } else {
      form?.classList.add("translate-y-full");
      button.textContent = "‚Üë";
    }
  });
</script>
