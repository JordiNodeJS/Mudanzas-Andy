---
import "../styles/global.css";
import CookieBanner from "../components/CookieBanner.astro";
import { ClientRouter } from "astro:transitions";

// Configuraci√≥n temporal directo en el Layout para asegurar que funcione en producci√≥n
const analyticsConfig = {
  google: {
    analytics: {
      measurement_id: "G-VK65C53TET",
    },
    search_console: {
      verification_code: "",
    },
    tag_manager: {
      container_id: "GTM-5NH8WKQC",
    },
  },
  bing: {
    webmaster_tools: {
      verification_code: "E00F433172C8065A658092822181BD08",
    },
  },
  meta: {
    domain_verification: "",
  },
};

interface Props {
  title?: string;
  description?: string;
  image?: string;
  canonical?: string;
  keywords?: string;
  robots?: string;
}

const {
  title = "Mudanzas Profesionales Barcelona ‚ö° Presupuesto GRATIS | Mudanzas ANDY",
  description = "üöõ Mudanzas profesionales en Barcelona y Espa√±a. ‚úÖ Presupuesto GRATIS en 5 min por WhatsApp ‚úÖ Precio cerrado sin sorpresas ‚úÖ Atenci√≥n 24/7 ‚úÖ Embalaje incluido",
  image = "/og-image.jpg",
  canonical = Astro.url.href,
  keywords = "mudanzas Barcelona, mudanzas profesionales, empresa mudanzas Barcelona, mudanzas baratas, presupuesto mudanza gratis, mudanzas particulares, mudanzas oficinas",
  robots = "index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1",
} = Astro.props satisfies Props;
---

<!doctype html>
<html lang="es">
  <head>
    <!-- Google Tag Manager (head) -->
    <script>
      (function (w, d, s, l, i) {
        // Use safe casts to avoid TypeScript DOM typing errors during `astro check`
        (w as any)[l] = (w as any)[l] || [];
        (w as any)[l].push({
          "gtm.start": new Date().getTime(),
          event: "gtm.js",
        });
        var f = d.getElementsByTagName(s)[0] as HTMLScriptElement | undefined,
          j = d.createElement(s) as HTMLScriptElement,
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        if (f && f.parentNode) {
          f.parentNode.insertBefore(j, f);
        }
      })(window, document, "script", "dataLayer", "GTM-5NH8WKQC");
    </script>
    <!-- End Google Tag Manager -->

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Favicons generated from the truck logo -->
    <link rel="icon" href="/favicons/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicons/favicon-32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicons/favicon-16.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicons/apple-touch-icon.png"
    />
    <!-- SVG fallback / source of truth -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- CORE WEB VITALS OPTIMIZATION: Critical Resource Hints -->
    <!-- CRITICAL: Preload hero images con media queries espec√≠ficas -->
    <link
      rel="preload"
      as="image"
      href="/camion/optimized/hero-fondo-mobile.avif"
      type="image/avif"
      media="(max-width: 768px)"
      fetchpriority="high"
    />
    <link
      rel="preload"
      as="image"
      href="/camion/optimized/hero-fondo.avif"
      type="image/avif"
      media="(min-width: 769px)"
      fetchpriority="high"
    />

    <!-- CRITICAL: DNS prefetch para recursos externos cr√≠ticos -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />
    <link rel="dns-prefetch" href="//www.googletagmanager.com" />

    <!-- CRITICAL: Preconnect para recursos cr√≠ticos above-the-fold -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- OPTIMIZED CRITICAL CSS - Solo Above The Fold esencial para reducir LCP/FCP -->
    <style>
      /* Reset b√°sico */
      html {
        scroll-padding-top: 5rem;
      }
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
      }

      /* Container cr√≠tico */
      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      /* Layout esencial - solo hero */
      .relative {
        position: relative;
      }
      .absolute {
        position: absolute;
      }
      .fixed {
        position: fixed;
      }
      .inset-0 {
        inset: 0;
      }
      .z-40 {
        z-index: 40;
      }
      .z-50 {
        z-index: 50;
      }

      /* Hero section cr√≠tico */
      .min-h-screen {
        min-height: 100vh;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-center {
        justify-content: center;
      }
      .text-center {
        text-align: center;
      }

      /* Typography cr√≠tico - solo hero */
      .text-3xl {
        font-size: 1.875rem;
        line-height: 2.25rem;
      }
      .text-4xl {
        font-size: 2.25rem;
        line-height: 2.5rem;
      }
      .text-5xl {
        font-size: 3rem;
        line-height: 1;
      }
      .font-bold {
        font-weight: 700;
      }
      .leading-tight {
        line-height: 1.25;
      }

      /* Colors cr√≠ticos - sistema centralizado */
      :root {
        --color-primary: 38 78 112;
        --color-secondary: 103 145 134;
        --color-accent: 249 180 171;
        --color-highlight: 250 227 96;
        --color-neutral: 187 212 206;
      }

      .text-white {
        color: rgb(255 255 255);
      }
      .text-gray-100 {
        color: rgb(243 244 246);
      }
      .text-primary {
        color: rgb(var(--color-primary));
      }

      /* Spacing cr√≠tico - solo hero */
      .p-6 {
        padding: 1.5rem;
      }
      .px-6 {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
      .py-8 {
        padding-top: 2rem;
        padding-bottom: 2rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mb-6 {
        margin-bottom: 1.5rem;
      }
      .mt-6 {
        margin-top: 1.5rem;
      }

      /* Button cr√≠tico - solo CTA principal */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-decoration: none;
        border-radius: 0.5rem;
        transition: all 0.2s;
        border: 2px solid transparent;
      }
      .btn-primary {
        background-color: rgb(var(--color-primary));
        color: white;
      }
      .btn-primary:hover {
        background-color: rgb(var(--color-primary) / 0.9);
      }

      /* Responsive cr√≠tico - solo breakpoint principal */
      @media (min-width: 768px) {
        .container {
          padding: 0 2rem;
        }
        .md\\:text-5xl {
          font-size: 3rem;
          line-height: 1;
        }
        .md\\:text-6xl {
          font-size: 3.75rem;
          line-height: 1;
        }
        .md\\:px-8 {
          padding-left: 2rem;
          padding-right: 2rem;
        }
      }

      /* Loading states */
      .loading {
        opacity: 0.7;
      }
      .loaded {
        opacity: 1;
        transition: opacity 0.3s;
      }

      /* View transitions b√°sico */
      @view-transition {
        navigation: auto;
      }
      @media (prefers-reduced-motion: reduce) {
        ::view-transition-old(root),
        ::view-transition-new(root) {
          animation-duration: 0.01s;
        }
      }
    </style>

    <!-- Non-critical CSS cargado de forma as√≠ncrona -->
    <link
      rel="preload"
      href="/styles/main.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript><link rel="stylesheet" href="/styles/main.css" /></noscript>

    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="robots" content={robots} />
    <link rel="canonical" href={canonical} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.url).href} />
    <meta property="og:image:alt" content={title} />
    <meta property="og:site_name" content="Mudanzas ANDY" />
    <meta property="og:locale" content="es_ES" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonical} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.url).href} />
    <meta property="twitter:image:alt" content={title} />

    <!-- Structured Data JSON-LD -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "MovingCompany",
        "name": "Mudanzas ANDY",
        "description": "Empresa profesional de mudanzas en Barcelona y Espa√±a. Presupuesto gratuito en 5 minutos por WhatsApp.",
        "url": "https://mudanzas-andy.es",
        "telephone": "+34-XXX-XXX-XXX",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Barcelona",
          "addressCountry": "ES"
        },
        "serviceArea": {
          "@type": "Place",
          "name": "Espa√±a"
        },
        "services": [
          "Mudanzas dom√©sticas",
          "Mudanzas de oficina",
          "Mudanzas internacionales",
          "Embalaje profesional"
        ]
      }
    </script>

    <!-- Verification meta tags -->
    {
      analyticsConfig.google.search_console.verification_code && (
        <meta
          name="google-site-verification"
          content={analyticsConfig.google.search_console.verification_code}
        />
      )
    }
    {
      analyticsConfig.bing.webmaster_tools.verification_code && (
        <meta
          name="msvalidate.01"
          content={analyticsConfig.bing.webmaster_tools.verification_code}
        />
      )
    }

    <!-- Font optimization with display: swap -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- Google Tag Manager (body) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-5NH8WKQC"
        height="0"
        width="0"
        style="display: none; visibility: hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- View Transitions Router optimizado -->
    <ClientRouter />

    <!-- Main content -->
    <slot />

    <!-- Cookie Banner -->
    <CookieBanner />
  </body>
</html>
